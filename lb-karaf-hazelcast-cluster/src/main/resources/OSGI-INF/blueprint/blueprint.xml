<blueprint
        xmlns    = "http://www.osgi.org/xmlns/blueprint/v1.0.0"
        xmlns:cm = "http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0">

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <!--
    {
      "nodes" :  {
        "kha-1" : {
          "groups" : {
              "G1" : { "services" : [ "service-1", "service-2" ] },
              "G2" : { "services" : [ "service-3", "service-4" ] }
            }
          }
        },
        "kha-2" : {
          "groups" : {
              "G1" : { "services" : [ "service-1", "service-2" ] },
              "G2" : { "services" : [ "service-3", "service-4" ] }
            }
          }
        }
      }
    }
    -->

    <cm:property-placeholder persistent-id="com.github.lburgazzoli.karaf.hazelcast.cluster" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="node.id"                    value="ha"/>
            <cm:property name="node.leader.eligible"       value="false"/>
            <cm:property name="node.leader.check.delay"    value="30"/>
            <cm:property name="node.leader.check.interval" value="60"/>
            <cm:property name="node.config"                value="none"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <reference
        id        = "karaf-hazelcast-manager"
        interface = "com.github.lburgazzoli.karaf.hazelcast.IHazelcastManager"
        filter    = "(osgi.jndi.service.name=karaf-hazelcast-manager)"/>
    <reference
        id        = "karaf-config-admin"
        interface = "org.osgi.service.cm.ConfigurationAdmin"/>

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <bean id             = "karaf-cluster-context"
          class          = "com.github.lburgazzoli.karaf.hazelcast.cluster.ClusterContext"
          scope          = "singleton">
        <property name="bundleContext"    ref="blueprintBundleContext"/>
        <property name="hazelcastManager" ref="karaf-hazelcast-manager"/>
    </bean>

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <bean id             = "karaf-cluster-agent"
          class          = "com.github.lburgazzoli.karaf.hazelcast.cluster.ClusterAgent"
          init-method    = "init"
          destroy-method = "destroy"
          scope          = "singleton">
        <property name="nodeId"                  value="${node.id}"/>
        <property name="nodeConfiguration"       value="${node.config}"/>
        <property name="leaderEligible"          value="${node.leader.eligible}"/>
        <property name="leadershipCheckInterval" value="${node.leader.check.interval}"/>
        <property name="leadershipCheckDelay"    value="${node.leader.check.delay}"/>
        <property name="clusterContext"          ref="karaf-cluster-context"/>

    </bean>

    <reference-list
        id="lb-service-reference-listerner"
        interface="com.github.lburgazzoli.cluster.IClusteredService"
        availability="optional">
        <reference-listener
            ref="karaf-cluster-agent"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference-list>

    <service ref="karaf-cluster-agent">
        <interfaces>
            <value>com.github.lburgazzoli.cluster.IClusterAgent</value>
        </interfaces>
        <service-properties>
            <entry key   = "osgi.jndi.service.name"
                   value = "karaf-cluster-agent"/>
        </service-properties>
    </service>

</blueprint>
