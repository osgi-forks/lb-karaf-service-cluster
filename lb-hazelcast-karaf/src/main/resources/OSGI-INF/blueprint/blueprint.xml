<blueprint
        xmlns    = "http://www.osgi.org/xmlns/blueprint/v1.0.0"
        xmlns:cm = "http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0">

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <cm:property-placeholder persistent-id="com.github.lburgazzoli.cluster.hz" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="hz.cache.config" value="./etc/hazelcast-cache.xml"/>
            <cm:property name="hz.cache.name"   value="karaf-cluster"/>
            <cm:property name="cluster.id"      value="ha1"/>
            <cm:property name="cluster.groups"  value="G1,G2,G3"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <bean id             = "lb-hazelcast-classloader"
          class          = "com.github.lburgazzoli.osgi.OSGiClassLoader"
          init-method    = "init"
          destroy-method = "destroy"
          scope          = "singleton"/>

    <bean id    = "lb-hazelcast-cfg"
          class = "com.hazelcast.config.FileSystemXmlConfig"
          scope = "singleton">
        <argument value = "${hz.cache.config}"/>
    </bean>

    <bean id             = "lb-hazelcast-manager"
          class          = "com.github.lburgazzoli.hazelcast.common.osgi.HazelcastManager"
          init-method    = "init"
          destroy-method = "destroy"
          scope          = "singleton">
        <argument ref = "blueprintBundleContext"/>
        <argument ref = "lb-hazelcast-cfg"/>
        <argument ref = "lb-hazelcast-classloader"/>
    </bean>

    <service ref="lb-hazelcast-manager">
        <interfaces>
            <value>com.github.lburgazzoli.hazelcast.common.osgi.IHazelcastManager</value>
        </interfaces>
        <service-properties>
            <entry key   = "osgi.jndi.service.name"
                   value = "lb-hazelcast-manager"/>
        </service-properties>
    </service>

    <!-- ******************************************************************* -->
    <!--                                                                     -->
    <!-- ******************************************************************* -->

    <bean id             = "lb-cluster-agent"
          class          = "com.github.lburgazzoli.hazelcast.karaf.cluster.ClusterAgent"
          init-method    = "init"
          destroy-method = "destroy"
          scope          = "singleton">
        <property name="clusterId"        value="${cluster.id}"/>
        <property name="clusterGroups"    value="${cluster.groups}"/>
        <property name="bundleContext"    ref="blueprintBundleContext"/>
        <property name="hazelcastManager" ref="lb-hazelcast-manager"/>
    </bean>

    <reference-list
        id="lb-service-reference-listerner"
        interface="com.github.lburgazzoli.cluster.IClusteredService"
        availability="optional">
        <reference-listener
            ref="lb-cluster-agent"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference-list>

    <service ref="lb-cluster-agent">
        <interfaces>
            <value>com.github.lburgazzoli.cluster.IClusterAgent</value>
        </interfaces>
        <service-properties>
            <entry key   = "osgi.jndi.service.name"
                   value = "lb-cluster-agent"/>
        </service-properties>
    </service>

    <!-- ******************************************************************* -->
    <!-- COMMANDS                                                            -->
    <!-- ******************************************************************* -->

    <command-bundle xmlns="http://karaf.apache.org/xmlns/shell/v1.0.0">
        <command name="cluster/node-list">
            <action class="com.github.lburgazzoli.hazelcast.karaf.cluster.cmd.NodeList">
                <property name="service" ref="lb-cluster-agent"/>
            </action>
        </command>
    </command-bundle>

</blueprint>
